CameraStates = {
    Red = {
        position = {
            x = -16.5583878,
            y = -2.5,
            z = -14
        },
        pitch = 90,
        yaw = 0,
        distance = 20
    },
    Orange = {
        position = {
            x = -16.5583878,
            y = -2.5,
            z = 0
        },
        pitch = 90,
        yaw = 0,
        distance = 20
    },
    Yellow = {
        position = {
            x = -16.5583878,
            y = -2.5,
            z = 11
        },
        pitch = 90,
        yaw = 0,
        distance = 20
    },
    Blue = {
        position = {
            x = 14.5,
            y = -2.5,
            z = 0
        },
        pitch = 90,
        yaw = 0,
        distance = 20
    },
    Purple = {
        position = {
            x = 14.5,
            y = -2.5,
            z = -14
        },
        pitch = 90,
        yaw = 0,
        distance = 20
    },
    Teal = {
        position = {
            x = 14.5,
            y = -2.5,
            z = 11
        },
        pitch = 90,
        yaw = 0,
        distance = 20
    },
    Green = {
        position = {
            x = -16.5583878,
            y = -2.5,
            z = 23
        },
        pitch = 90,
        yaw = 0,
        distance = 20
    },
    Multi = {
        position = {
            x = -1,
            y = -2.5,
            z = 0
        },
        pitch = 90,
        yaw = 0,
        distance = 15
    },
}

Colors = {'Red', 'Orange', 'Yellow', 'Green', 'Teal', 'Blue', 'Purple'}

PlayerBoards = {
    Red = {'4b3a9e', 'df0dd7', 'dd9a11', '65e693', '0e0d58', '0e6cb8',
        '2186ff', 'bcd42b', '8cdd7c', 'b88daf', 'e8fe84', 'e0e383'},
    Orange = {'c1f6ed', '218833', 'b6a3bb', '23b599', '3340bf', '4fed4b',
        '173f6b', '1ed112', '465b50', 'fd8fa4', 'fb44d6', 'e8ed28'},
    Yellow = {'7db764', '462f81', '3dce1c', '96e4dd', 'f5949f', 'a5c289',
        '73947c', '8d8f04', '68129e', '217d9b', '53edce', 'b0f3c1'},
    Blue = {'b5ad97', '00d6f0', '4c499b', '4c8fac', '428bf0', '727bf9',
        '9c866a', '737b97', 'e4f4a6', '5b61f4', 'a9957e', '716f2c'},
    Purple = {'dd2ded', 'a8a985', '9c4b0c', '64b697', '33a93a', '667627',
        'a01003', '88a32c', '2c9482', '4d4260', '34871c', 'fea48b'},
    Green = {'8b8731', 'c79482', 'e4427a', '243526', '524465', '54b0f0', 
        '8be4cc', '7bbda6', 'fefad9', 'e991c5', '0d2e0f', '640746'},
    Teal = {'d3cbf1', '0ff5c6', 'd10c8e', '4bec1d', '4a4a95', 'e24447', 
        'cf439d', '130dd5', '704b4f', '0443ff', '5e5b05', 'f2289f'}
}

PlayerCubes = {
  Red = {'c3fad2', 'e3d8bd', '866851'},
  Orange = {'5e6458', 'cb0bf7', '583ef4'},
  Yellow = {'c0f66c','b2271a','19bd7d'},
  Blue = {'8a2f0c', '7e81ce', '70c25d'},
  Purple = {'204671', '9c1b52', 'e4c4f9'},
  Green = {'60da38', 'a7be6e', 'f1e307'},
  Teal = {'46faa7', '671fa8', '0c1379'}
}

DeploySections = {
    Red = {'1e91c0', '0a9a51', '7132c1', 'ce2d11', 'a60744', '9172b3',
        '052e97', '0ff00e', 'b9ad35', 'd12f6a', 'b668f0', 'd49bb4'},
    Orange = {'4f84b3', '14f65b', '6ee3a4', 'a96c73', '40e87d', '0db2ae', 
        'b68952', 'c8bf64', 'c1e65c', '2160f9', '741b75', 'f53898'},
    Yellow = {'3606da', 'f5bb44', '6afbe6', '74912e', 'a1c3be', '29a023', 
        '1e1664', '1e17d8', '3f603e', 'bd8b7d', '63c219', 'db0d1b'},
    Blue = {'c42ac6', '9271b3', 'c1cca0', 'ae787c', '42aa9b', '447f81',
        '469ac7', '60ead7', '343588', '7de7bf', 'cd5412', '175990'},
    Purple = {'671ba5', '69e7bd', '26c451', '9ddcc1', '7e1222', '91e5e6',
        'c433fe', '17894d', '93d12e', 'e37bb3', '4bf917', '4af6a4'},
    Green = {'0c51dc', 'f1c60d', 'c3a004', 'e6f5cb', 'd82032', 'c4e8dd', 
        'c8c991', '644a2f', '8c7e8e', '9fd723', 'ead3c7', '3d1adc'},
    Teal = {'0a0cd8', '0c7fa9', '78e6a6', 'c65120', '3bfe34', 'a59662', 
        'f46e79', '2ed802', 'b38166', '647645', '106c41', '5e27c9'}
}

LastDropped = {
    Red = {},
    Orange = {},
    Yellow = {},
    Blue = {},
    Purple = {},
    Green = {},
    Teal = {}
}

heightIncrement = -0.01
heightFirst = 1.17
rightIncrements = {0, 1.42, 2.82, 4.21, 5.95, 7.35, 8.74, 10.14, 11.87, 13.27, 14.66, 16.07}

TallDeployments = {'c08c9b', '5b4153', 'e2a4c6', 'c572af', 'b0e8f8', '1394ec', '07b1d1'}
TallerDeployments = {'11d1fc', 'f0d126', 'ce3512', 'd1d0ea', '66ac96', '1bc92b', '8fadea', '3a81fe', '65d15a', '233671', '26f271', '1aa4c6', 'eb14a4', 'd0a0ae'}

CardPosition = {
    Red = { up = -10.9, right = -23.74, orig = -11.03 },
    Orange = { up = 1.1, right = -23.74, orig = 0.97 },
    Yellow = { up = 13.12, right = -23.74, orig = 12.97 },
    Blue = { up = 1.1, right = 8.26, orig = 0.97 },
    Purple = { up = -10.9, right = 8.26, orig = -11.03 },
    Green = { up = 25.12, right = -23.74, orig = 24.97 },
    Teal = { up = 13.12, right = 8.26, orig = 12.97 }
}

SectorDecks = {'c1471e', '9f6e2d', '709338'}

SectorDeckColors = {
    {0, 1, 0},
    {1, 1, 0},
    {1, 0, 1}
}

Sectors = {}
Sectors[1] = {'2f6af8', '3fd8b0', '4faee4', '6f1ab7', '4e14f6', 'f45664'}
Sectors[2] = {'f2a756', 'dcbd86', '1aae77', 'd39780', 'dd4e5a', '44ebd0'}
Sectors[3] = {'abf34d', '3c1ec6', '3454b5', 'a406ac', 'ad25a1', '6d85cc'}

ColonyCardsZone = 'ebc15a'

ShyPlutoDiceY = 1.25
ShyPlutoDiceX = {-1.62, -0.81, 0.02, 0.81, 1.60, 2.42}
ShyPlutoDiceZ = 19.61
ShyPlutoDiceZone = '3f8721'
ShyPlutoButton = '3c5547'
ShyPlutoBag = {
    Red = '9c8343',
    Pink = 'd9970b',
    Pilot = {
        Red = '70922d', 
        Orange = '4e3b9a',
        Yellow = '5e8e30',
        Green = '29345b',
        Blue = '66d5fe',
        Teal = '9b1908',
        Purple = 'e03c21'
    }
}

haveBiodome = false
haveDreadnaught = false
haveShyPluto = false
haveCommandStation = false
gameStarted = false
resupplyInProgress = {}
resupplyInProgress[1] = false
resupplyInProgress[2] = false
resupplyInProgress[3] = false
resupplyInProgress[4] = false

AutoRoll = {
    Red = '5acb43', 
    Orange = '56e44d',
    Yellow = '2d7101',
    Green = '3a5253',
    Blue = '2c9227',
    Teal = 'cfed10',
    Purple = '59757b'
}
AutoRollZones = {
    Red = '9e1e40', 
    Orange = '4de647',
    Yellow = 'f90ed4',
    Green = 'c22c7b',
    Blue = '31f9ef',
    Teal = '340eb2',
    Purple = 'f44f1f'
}

DiceTags = {
    'bonus roll',
    'charge',
    'credits',
    'income',
    'pluto',
    'ship',
    'victory points'
}

function onLoad()
    math.randomseed(os.time())
    -- Set items uninteractable
    for key,value in ipairs({
            -- Player Boards
            'e58bea', '93553d', '2eaddb', 'fc21ad', 'a917cc', '0b40bb', '707903', 
            -- Table
            '12c65e', 'f938a2', 'afc863', '9f95fd', 'c8edca', '35b95f', '393bf7', '5af8f2', '4ee1f2',
            -- Shy Pluto Card
            '688aa1',
            -- Auto Roll Zones
            AutoRoll['Red'], AutoRoll['Orange'], AutoRoll['Yellow'], AutoRoll['Green'], AutoRoll['Blue'], AutoRoll['Teal'], AutoRoll['Purple'],
            -- Floor and stools
            'b1cad7', '5f9ba8', '28c93d'
        }) do
        getObjectFromGUID(value).interactable = false
    end
    
    SwapButton = getObjectFromGUID('644a28')
    SwapButton.createButton({
        click_function = "swapSectorCards",
        function_owner = Global,
        label          = "Swap Sectors",
        position       = {0,0,0},
        rotation       = {0,180,0},
        width          = 850,
        height         = 10,
        font_size      = 100,
        color          = {50/255, 180/255, 30/255},
        font_color     = {1, 1, 1},
    })
    
    for k=1,3 do
        getObjectFromGUID(SectorDecks[k]).createButton({
            click_function = "resupplySector" .. k,
            function_owner = Global,
            label          = "Resupply",
            position       = {0,0.4,-0.35},
            rotation       = {0,180,0},
            width          = 500,
            height         = 20,
            font_size      = 100,
            color          = {0, 0, 0},
            font_color     = SectorDeckColors[k]
        })
    end
    
    for c=1,7 do
        for k=1,12 do
            getObjectFromGUID(PlayerBoards[Colors[c]][k]).createButton({
                click_function = Colors[c] .. "Deploy" .. k,
                function_owner = Global,
                label          = "Deploy",
                position       = {0.05,-0.15,1.25},
                rotation       = {0,180,0},
                width          = 300,
                height         = 200,
                font_size      = 70,
                color          = {0, 0, 0},
                font_color     = {1, 1, 1},
            })
        end
    end
    
    BuyButton = getObjectFromGUID('9a99c3')
    BuyButton.createButton({
        click_function = "resetCurrency",
        function_owner = Global,
        label          = "Reset Currency",
        position       = {0,0,0},
        rotation       = {0,180,0},
        width          = 750,
        height         = 200,
        font_size      = 100,
        scale          = {x=1, y=1, z=2},
        color          = {0, 0, 0},
        font_color     = {1,1,1}
        
    })
end

function resetCurrency(button, color)
    if (isPlayerColor(color)) then
        local moneyCube = getObjectFromGUID(PlayerCubes[color][1])
        local incomeCube = getObjectFromGUID(PlayerCubes[color][2])
        local moneyPos = moneyCube.getPosition()
        local incomePos = incomeCube.getPosition()
        moneyCube.setPositionSmooth({incomePos[1], moneyPos[2], moneyPos[3]})
    else
        print('You must first select a player color to reset your currency.')
    end
end

function onObjectDrop(colorName, obj)
    LastDropped[colorName] = obj.guid
end

function onObjectEnterScriptingZone(zone, card)
    -- Only act if dropped in the auto deploy script zone
    if (zone.guid != '73274b') then return end
    -- Find the color that dropped this card
    for key, playerColor in ipairs(getSeatedPlayers()) do
        -- Do nothing if this is a non player
        if (isPlayerColor(playerColor) == false) then return end
        -- Get the color of the player who dropped the card
        if (LastDropped[playerColor] == card.guid) then
            for k, rotationValue in ipairs(card.getRotationValues()) do
                -- Sector number
                local sectorNumber = rotationValue.value
                if (string.find(sectorNumber, '+')) then
                    print('A ' .. sectorNumber .. ' card must be manually deployed.')
                    return
                end
                
                sectorNumber = tonumber(sectorNumber)
                local sectorPileObject = getObjectFromGUID(PlayerBoards[playerColor][sectorNumber])
                local deployGuid = DeploySections[playerColor][sectorNumber]
                deploy(sectorPileObject, sectorNumber, deployGuid, playerColor, false)
                local right = CardPosition[playerColor].right + rightIncrements[sectorNumber]
                card.setPositionSmooth({right, 2, CardPosition[playerColor].orig})
                card.setRotationSmooth({0,180,0})
            end
        end
    end
end

function hasPlayerSelectedColors()
    hasPlayerColors = false;
    for key,value in ipairs(getSeatedPlayers()) do
        if (isPlayerColor(value)) then
            hasPlayerColors = true
        end
    end
    return hasPlayerColors
end

function checkDestruct(obj)
    if (obj != nil) then
        obj.destruct()
    end
end

function start()
    if (not hasPlayerSelectedColors()) then
        print('At least one player must select a color before starting the game.')
        return
    end
    UI.hide('StartPanel')
    
    addDreadnaught()
    addShyPluto()
    addBiodome()
    
    -- Wait for the decks to combine before shuffling and handing out cards
    Wait.time(startShuffleDeal, 0.1)
end

function addDreadnaught()
    dreadnaughtDeck = getObjectFromGUID('b7c897')
    if (haveDreadnaught) then
        print('Adding Dreadnaught.')
        dreadnaughtDeck.setPosition({-3.81, 1.22, -0.49})
    else
        print('Removing Dreadnaught.')
        checkDestruct(dreadnaughtDeck)
    end
end

function addShyPluto()
    shyPlutoSector1 = getObjectFromGUID('fc7e02')
    shyPlutoSector2 = getObjectFromGUID('2a65b9')
    shyPlutoSector3 = getObjectFromGUID('32d0c5')
    if (haveShyPluto) then
        print('Adding Shy Pluto.')
        shyPlutoSector1.setPosition({-3.83, 1.22, 3.06})
        shyPlutoSector2.setPosition({-3.81, 1.22, -0.49})
        shyPlutoSector3.setPosition({-3.78, 1.16, -3.87})
        
        pinkDiceBag = getObjectFromGUID(ShyPlutoBag['Pink'])
        pinkDiceBag.shuffle()
        resupplyInProgress[4] = true
        Wait.time(function() resupplyInProgress[4] = false end, 2)
        
        for k=1,6 do
            pinkDiceBag.takeObject({
                position = {x=ShyPlutoDiceX[k], y=ShyPlutoDiceY, z=ShyPlutoDiceZ},
                rotation = {x=270, y=180, z=0},
                smooth = true
            })
        end
        checkDestruct(pinkDiceBag)
        
        -- Shuffle the red dice
        getObjectFromGUID(ShyPlutoBag['Red']).shuffle()
    else
        print('Removing Shy Pluto.')
        checkDestruct(shyPlutoSector1)
        checkDestruct(shyPlutoSector2)
        checkDestruct(shyPlutoSector3)
        -- Dice bags, dice, world eater cards, pdf
        removals = {
            ShyPlutoBag['Pilot']['Red'],
            ShyPlutoBag['Pilot']['Orange'],
            ShyPlutoBag['Pilot']['Yellow'],
            ShyPlutoBag['Pilot']['Green'],
            ShyPlutoBag['Pilot']['Blue'],
            ShyPlutoBag['Pilot']['Teal'],
            ShyPlutoBag['Pilot']['Purple'],
            AutoRoll['Red'],
            AutoRoll['Orange'],
            AutoRoll['Yellow'],
            AutoRoll['Green'],
            AutoRoll['Blue'],
            AutoRoll['Teal'],
            AutoRoll['Purple'],
            ShyPlutoBag['Red'],
            ShyPlutoBag['Pink'], '688aa1', '633ea0', 'a7bbb5', '897909', '0ccf00', '7622da', '29df5a',
            -- Extra dice by ROYGTBP
            '284842', '99eb0f',
            '887110', '4fbd20',
            'f2095b', '6b0985',
            '4f72e5', '460a76',
            '4d7108', '7c2bed',
            'bf288d', 'd86ace',
            '255f76', '7f8d0c'
        }
        
        for key,value in ipairs(removals) do
            checkDestruct(getObjectFromGUID(value))
        end
    end
end

function addBiodome()
    biodomeSector1 = getObjectFromGUID('3a8b4d')
    biodomeSector2 = getObjectFromGUID('347c84')
    biodomeSector3 = getObjectFromGUID('408a70')
    biodomeColonyCards = getObjectFromGUID('c6d40a')
    if (haveBiodome) then
        print('Adding Biodome Sector Cards.')
        biodomeSector1.setPosition({-3.83, 1.22, 3.06})
        biodomeSector2.setPosition({-3.81, 1.22, -0.49})
        biodomeSector3.setPosition({-3.78, 1.16, -3.87})
        print('Adding Biodome Colony Cards.')
        biodomeColonyCards.shuffle()
        searchedBiodomeCards = {}
        foundBiodomeCardTotal = 0
        checkBiodomeColonyCard()
    else
        print('Removing Biodome.')
        checkDestruct(biodomeSector1)
        checkDestruct(biodomeSector2)
        checkDestruct(biodomeSector3)
        checkDestruct(biodomeColonyCards)
    end
end

-- Switch out 6 different sector colony cards with biodome colony cards
function checkBiodomeColonyCard()
    biodomeColonyCards.takeObject({
        flip = true,
        position = {10.12, 2, 30.34},
        smooth = true,
        callback_function = function(card)
            local sectorNumber = card.getRotationValue()                  
            if foundBiodomeCardTotal < 6 then
                -- Only switch out colony cards if the sector hasn't already been switched
                if searchedBiodomeCards[sectorNumber] == nil then
                    searchedBiodomeCards[sectorNumber] = true
                    foundBiodomeCardTotal = foundBiodomeCardTotal + 1
                    
                    colonyCard = findColonySectorCard(sectorNumber)
                    local colonyPosition = colonyCard.getPosition()
                    
                    colonyCard.setPositionSmooth({10.12, 1.2, 30.34})
                    card.setPositionSmooth(colonyPosition)
                end
                -- Since there aren't 6 switched colony cards, run the function again
                _G['checkBiodomeColonyCard']()
            end
        end
    })
end

function findColonySectorCard(sectorNumber)
    local cards = getObjectFromGUID(ColonyCardsZone).getObjects()
    for index, card in ipairs(cards) do
        if (string.find(card.type, 'Card') and card.getRotationValue() == sectorNumber) then
            return card
        end
    end
end

-- Start the game
function startShuffleDeal()
    -- Shuffle the sector decks
    for k=1,3 do
        find_pile(getObjectFromGUID(SectorDecks[k])).shuffle()
    end
    print('Shuffling decks.')
    
    -- Enabling turns will trigger the onTurnEnd function, which will resupply the marketplace
    Turns.enable = true    
    print('Resupplying marketplace.')

    -- Starting card locations
    local Starters = {
        Red = {-22.42, 4, -16.78},
        Orange = {-22.42, 4, -5.22},
        Yellow = {-22.42, 4, 6.80},
        Green = {-22.42, 4, 18.80},
        Purple = {10.26, 4, -16.41},
        Blue = {10.26, 4, -5.22},
        Teal = {10.26, 4, 6.80}
    }

    -- Deal starting cards (and pilot tokens if playing Shy Pluto) for active players
    Sector1Deck = find_pile(getObjectFromGUID(SectorDecks[1]))
    for key, value in ipairs(getSeatedPlayers()) do
        if (isPlayerColor(value)) then
            Sector1Deck.takeObject({
                position = Starters[value],
                rotation = {0,180,0}
            })
            local PilotBag = getObjectFromGUID(ShyPlutoBag['Pilot'][value])
            if (PilotBag != nil) then
                PilotBag.takeObject({
                    position = {x=Starters[value][1]+3, y=Starters[value][2], z=Starters[value][3]},
                    rotation = {0,180,0},
                    smooth = true
                })
            end
        end
    end
    print('Giving out starter cards.')
    
    gameStarted = true
end

function isPlayerColor(value)
    isColor = false
    for key, color in ipairs(Colors) do
        if (color == value) then isColor = true end
    end
    return isColor
end

function CameraViewClicked(player, value, id)
    player.lookAt(CameraStates[id])
end

-- Lua doesn't have a round function!
function round(num, numDecimalPlaces)
    local mult = 10^(numDecimalPlaces or 0)
    return math.floor(num * mult + 0.5) / mult
end

-- Swap all cards in a sector with those from another sector
function swapSectorCards()
    -- The sectors that the two checkers are on will determine which to swap
    Checker1 = getObjectFromGUID('3630f7')
    Checker2 = getObjectFromGUID('a12ea2')
    local locOne = getSectorLocation(Checker1)
    local locTwo = getSectorLocation(Checker2)
    if (locTwo[2] == 0 or locOne[2] == 0) then
        print("Both checkers must be on a sector to swap sectors.")
        return
    end
    if (locOne[1] != locTwo[1]) then
        print("You can't swap sectors from different player boards.")
        return
    end
    print('Swapping ', locOne[1], ' sectors ', locOne[2], ' and ', locTwo[2], '.')
    
    -- Return the checkers to the original location
    Checker1.setPositionSmooth({0.01, 1.12, -14.32})
    Checker2.setPositionSmooth({1.36, 1.12, -14.32})
    
    local Sector1 = getObjectFromGUID(PlayerBoards[locOne[1]][locOne[2]])
    local Sector2 = getObjectFromGUID(PlayerBoards[locOne[1]][locTwo[2]])
    local Deploy1 = getObjectFromGUID(DeploySections[locOne[1]][locOne[2]])
    local Deploy2 = getObjectFromGUID(DeploySections[locOne[1]][locTwo[2]])
    local Position1 = Sector1.getPosition()
    local Position2 = Sector2.getPosition()
    local DeployPosition1 = Deploy1.getPosition()
    local DeployPosition2 = Deploy2.getPosition()
    moveHorizontal(Sector1, Position2[1])
    moveHorizontal(Sector2, Position1[1])
    moveHorizontal(Deploy1, Position2[1])
    moveHorizontal(Deploy2, Position1[1])
end

function moveHorizontal(zone, xPosition)
    local objects = zone.getObjects()
    for _, object in ipairs(objects) do
        local type = object.tag
        if object.tag == "Card" or object.tag == "Deck" then
            local position = object.getPosition()
            object.setPositionSmooth({xPosition, position[2], position[3]})
        end
    end
end

function getSectorLocation(obj)
    local position = obj.getPosition()
    local right = round(position[1],1)
    local rightIndex = 0
    -- There are 24 x-positions the sectors can be in
    for k=1,24 do
        if (k < 13) then
            if (tostring(right) == tostring(round(CardPosition.Green.right + rightIncrements[k],1))) then
                rightIndex = k
            end
        else 
            if (tostring(right) == tostring(round(CardPosition.Purple.right + rightIncrements[k-12],1))) then
                rightIndex = k
            end
        end
    end   
    
    -- Determine the yPosition
    local upIndex = (round(position[3],0) + 23) / 12
    
    local color = ''
    if (rightIndex < 13) then
        if (upIndex == 1) then color = 'Red' end
        if (upIndex == 2) then color = 'Orange' end
        if (upIndex == 3) then color = 'Yellow' end
        if (upIndex == 4) then color = 'Green' end
    end
    if (rightIndex > 12) then
        if (upIndex == 1) then color = 'Purple' end
        if (upIndex == 2) then color = 'Blue' end
        if (upIndex == 3) then color = 'Teal' end
    end
    
    if (rightIndex > 12) then rightIndex = rightIndex - 12 end
    return {color, rightIndex}
end

-- Toggles expansions on/off
function toggleOption(player, value, id, key, title)
    local label = ''
    local color = 'rgb(0.5,0.5,0.5)'
    if _G[key] then
        _G[key] = false
        label = title .. ": Off"
    else
        _G[key] = true
        label = title .. ": On"
        color = 'rgb(0.2,0.52,1)'
    end
    UI.setAttributes(id, {
        text = label,
        textColor = 'white',
        color = color
    })
end

function biodomeToggle(player, value, id)
    toggleOption(player, value, id, 'haveBiodome', 'Biodome')
end

function dreadnaughtToggle(player, value, id)
    toggleOption(player, value, id, 'haveDreadnaught', 'Dreadnaught Pack')
end

function shyPlutoToggle(player, value, id)
    toggleOption(player, value, id, 'haveShyPluto', 'Shy Pluto')
end

-- Sorts a table
function spairs(t, order)
    -- collect the keys
    local keys = {}
    for k in pairs(t) do keys[#keys+1] = k end

    -- if order function given, sort by it by passing the table and keys a, b,
    -- otherwise just sort the keys 
    if order then
        table.sort(keys, function(a,b) return order(t, a, b) end)
    else
        table.sort(keys)
    end

    -- return the iterator function
    local i = 0
    return function()
        i = i + 1
        if keys[i] then
            return keys[i], t[keys[i]]
        end
    end
end

-- Deploy or undeploy a card from clicking the deploy button
function deployRouting(sector, xpos, deployGuid, color, altClick)
    if (altClick == false) then deploy(sector, xpos, deployGuid, color)
    else undeploy(sector, xpos, deployGuid, color)
    end
end

-- Takes the card on the station, flips it upside down, and tucks it under the board
-- and under the topmost deployed card of that sector
function deploy(sector, sectorNumber, deployGuid, color, altClick)
    sectorNumber = sectorNumber - 1
    local cards = {}
    
    -- Get the currently deployed cards
    local deployed = getObjectFromGUID(deployGuid)
    for index, card in ipairs(deployed.getObjects()) do
        local type = card.tag
        if (string.find(type, 'Deck') or string.find(type, 'Card')) then
            table.insert(cards, card)
        end
    end
    
    -- Reposition all deployed cards, which will fix any misalignment if a card was
    -- manually removed
    local deployedCount = 0;
    upSum = 0;
    -- Loop through deployed cards in y-position order and deploy them
    for index, card in spairs(cards, function(t,a,b) return t[b].getPosition()[3] > t[a].getPosition()[3] end) do
        upSum = upSum + getDeployHeight(card.guid)
        deployCard(card, sectorNumber, index-1, upSum, color)
        deployedCount = deployedCount + 1
    end
    
    -- Deploy the card in the station
    local foundCard = find_pile(sector)
    if foundCard != nil then
        upSum = upSum + getDeployHeight(foundCard.guid)
        deployCard(foundCard, sectorNumber, deployedCount, upSum, color)
    end
end

function getDeployHeight(guid)
    if has_value(TallDeployments, guid) then return 0.71 end
    if has_value(TallerDeployments, guid) then return 1.17 end
    return 0.55
end

-- Move the topmost deployed card back to the station
function undeploy(sector, xpos, deployGuid, color, altClick)
    local topPosition = nil
    local topCard = nil
    
    local deployed = getObjectFromGUID(deployGuid)
    for index, card in ipairs(deployed.getObjects()) do
        local type = card.tag
        if (string.find(type, 'Deck') or string.find(type, 'Card')) then
            if (topPosition == nil) then 
                topCard = card
                topPosition = topCard.getPosition()[3]
            end
            if (card.getPosition()[3] > topCard.getPosition()[3]) then
                topCard = card
            end
        end
    end
    
    if (topCard == nil) then return end
    topCard.setLock(false)
    local topCardPosition = topCard.getPosition()
    topCard.setPositionSmooth({topCardPosition[1], 1.23, CardPosition[color].orig})
    topCard.setRotationSmooth({0,180,0})
end

-- Move the station card to the topmost deployed spot
function deployCard(card, xpos, ypos, upSum, color)
    card.setRotationSmooth({0,360,0})
    card.setLock(true)
    local right = CardPosition[color].right + rightIncrements[xpos+1]
    local up = CardPosition[color].up + upSum
    local height = heightFirst + (heightIncrement*(ypos))
        card.setPosition({right, height, up})
end

-- Fill empty shy pluto spots by moving dice to the left, and then draw
-- new dice to fill remaining spots
function deployDice()
    if (resupplyInProgress[4] == true) then return end

    resupplyInProgress[4] = true
    Wait.time(function() resupplyInProgress[4] = false end, 2)
    local dice = {}
    
    local deployed = getObjectFromGUID(ShyPlutoDiceZone)
    if (deployed) then
        for key, die in ipairs(deployed.getObjects()) do
            local type = die.tag
            if (string.find(type, 'Dice')) then
                table.insert(dice, die)
            end
        end
    end
    
    lastEmptyPosition = 1;
    for index, die in spairs(dice, function(t,a,b) return t[b].getPosition()[1] > t[a].getPosition()[1] end) do
        die.setPositionSmooth({ShyPlutoDiceX[lastEmptyPosition], ShyPlutoDiceY, ShyPlutoDiceZ})
        lastEmptyPosition = lastEmptyPosition + 1
    end
    
    local redDiceBag = getObjectFromGUID(ShyPlutoBag['Red'])
    redDiceBag.shuffle()
    
    if (lastEmptyPosition < 7) then
        for k=lastEmptyPosition, 6 do
            redDiceBag.takeObject({
                position = {x=ShyPlutoDiceX[k], y=ShyPlutoDiceY, z=ShyPlutoDiceZ},
                rotation = {x=270, y=180, z=0},
                smooth = true
            })
        end
    end
end

-- Create all deploy functions since Tabletop Simulator doesn't support
-- passing parameters into buttons
for c=1,7 do
    for k=1,12 do
        -- Create a new global function
        _G[Colors[c] .. 'Deploy' .. k] = function(obj, color, alt_click) 
            deployRouting(obj, k, DeploySections[Colors[c]][k], Colors[c], alt_click)
        end
    end
end

for c=1,3 do
    _G['resupplySector' .. c] = function()
        resupplySector(c)
    end
end

-- Deal cards to refill the marketplace
function resupplySector(n)
    if (resupplyInProgress[n] == false) then
        
        resupplyInProgress[n] = true
        Wait.time(function() resupplyInProgress[n] = false end, 2)

        local deck = getObjectFromGUID(SectorDecks[n])
        local topCard = find_pile(deck)
        local sectors = {}
        for k=1,6 do
            sectors[k] = find_pile(getObjectFromGUID(Sectors[n][k]))
        end
        local sectorX = {-2.19, -0.76, 0.67, 2.10, 3.53, 4.96}
        local sectorY = {3.05, -0.49, -3.89}

        for k=1,6 do
            if (not sectors[k]) then
                if (topCard != nil) then
                    topCard.takeObject({flip=true, position = {sectorX[k], 1, sectorY[n]}})
                    for _, obj in ipairs(deck.getObjects()) do
                        if obj.tag == "Card" then
                            topCard.flip()
                            topCard.setPositionSmooth(sectors[k].getPosition())
                            break
                        end
                    end
                end
            end
        end
    end
end

-- Finds a deck or card in a zone
function find_pile(zone)
    if (zone == nil) then return end
    local objects = zone.getObjects()
    local num_decks = 0
    local deck = nil
    for index, object in ipairs(objects) do
        local type = object.tag
        if (string.find(type, 'Deck') or string.find(type, 'Card')) then
            num_decks = num_decks + 1
            deck = object
        end
    end
    if (num_decks==1) then
        return deck
    else
        return nil
    end
end

function onPlayerTurnEnd(color)
    resupplySector1()
    resupplySector2()
    resupplySector3()
    if (haveShyPluto) then
        deployDice()
        autoRollDice()
    end
end

-- Check if a table contains a value
function has_value(tab, val)
    for index, value in ipairs(tab) do
        if value == val then
            return true
        end
    end
    return false
end

-- Roll dice in auto-roll zones
function autoRollDice()    
    for key, color in ipairs(getSeatedPlayers()) do
        if (isPlayerColor(color) == true) then
        
            local zone = getObjectFromGUID(AutoRollZones[color])
            local diceValues = {
                charge = 0,
                credits = 0,
                income = 0,
                ship = 0
            }
            diceValues['bonus roll'] = 0
            diceValues['victory points'] = 0
            local dice = zone.getObjects()
            for _, die in ipairs(dice) do
                if die.hasTag('pluto') then
                    die.roll()
                end
            end
            
            monitorDice(color, dice)
        end
    end
end

--Monitors dice to come to rest
function monitorDice(color, dice)
    function coroutine_monitorDice()
        repeat
            local allRest = true
            for _, die in ipairs(dice) do
                if die ~= nil and die.resting == false then
                    allRest = false
                end
            end
            coroutine.yield(0)
        until allRest == true 

        local diceValues = sumDiceValues(dice)
        local message = '';
        for key, value in pairs(diceValues) do
            if (message ~= '') then message = message .. ', ' end
            message = message .. value .. ' ' .. key
        end

        if (message ~= '') then
            broadcastToColor(message, color, stringColorToRGB(color))
        end
        return 1
    end
    startLuaCoroutine(self, "coroutine_monitorDice")
end

function sumDiceValues(dice)
    local diceValues = {}
    for _, die in ipairs(dice) do
        -- Only dice have a rotation value
        if (die.tag == 'Dice') then
            local rotationValue = die.getRotationValue()
            -- Don't show any values that are 0
            if (tonumber(rotationValue) > 0) then
                -- Don't count "pluto" as a tag
                for _, tag in ipairs(die.getTags()) do
                    if (tag ~= 'pluto') then
                        -- If this tag hasn't be set, it needs to be defaulted to 0
                        if (diceValues[tag] == nil) then diceValues[tag] = 0 end
                        diceValues[tag] = diceValues[tag] + die.getRotationValue()
                    end
                end
            end
        end
    end
    return diceValues;
end
